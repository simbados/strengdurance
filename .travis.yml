language: node_js
node_js:
- node
services:
- docker
env:
  global:
  - JWT_SECRET=TEST_SECRET
  - JWT_EXPIRY=1800
os: linux
cache:
  directories:
  - "$HOME/.npm"
before_install:
- cd server/
- npm i -g @nestjs/cli
install:
- npm install
  # - stage: test
  #   script: npm run test
  # - 
  #   script: npm run test:e2e
before_install:
- pip install --user awscli
- export PATH=$PATH:$HOME/.local/bin
script:
- eval $(aws ecr get-login --no-include-email --region us-east-2)
- docker-compose build
- docker tag strengdurance/server:latest 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:server-latest
- docker tag strengdurance/frontend:latest 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:frontend-latest
- docker push 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:server-latest
- docker push 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:frontend-latest

deploy:
    provider: elasticbeanstalk
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    region: "us-east-2"
    app: "Strengthdurance"
    env: "Strengthdurance-env"
    bucket_name: "strengthdurance-s3-bucket-server"
    on: 
      branch: master
