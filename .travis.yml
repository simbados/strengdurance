language: node_js
node_js:
- node
services:
- docker
env:
  global:
  - JWT_SECRET=TEST_SECRET
  - JWT_EXPIRY=1800
  - secure: XWMIUNuiwJpXb8+xN6F5Tah5/fvXx/biPq9JwtDij/JHTgCd1q88yCRu8vIX2AhiJGXJXcP9/FB6fAhA/jj+sbE9TlmH0PJ7IL51Ym2o/7WjsXfv6fRKlnvUaGxUnUz6E2ngy8yB93UTukNRsVXn6JbX7RY61rF7OgpSSuufJ669AJ3fzXXsvWJFOQQbeQ9CjgJ1mhotx+K9PYWxxkv8IbM4+0YQ6ZmWqfdjBc+IEOZcJ0KiBFZTJgTIkBeOLt83RdaN7DCFF2xZl1T9+I+kaeSWp1/kemAErhF2s8c6v8r1DSlAMuC4rpa1xhwp3rXV1bW/lpQVspZsdQnzT+MYKvKEyWrIHMuTBc3X7z5lDAohxPaA1Q7AlA4DUelV+0Mr8nNk/dEg3+z0quiCdjx4Z4RtVvByfyru4hDp//eMq0HewE6U/NfD8FSULrmV6PeGOujvnmRCutbK0v9zgVioLuZ87dbwJH3I0ymKpArX4vzRZulBqE8EnSdZNWySoz2YsuVd3yVIo+cHOXhowlYLX3tky78UFzJ0G2GYl6f8xN0BZz8ipFIRhfZJkh6yZXggWfjz7wp6FiEEjsAJRYc8gTcU6kUTurDL030dekgITcEdyPNQouN8r4tm8q8waRDcIalW4SGIgxLY9uMfa3su7tgxZaKg6G0REfMBJoQ9Jqg=
  - secure: mJ/E0edswr2iuCDCe7bhHIJe4pW0a+pFqtBy3FcgquMAFPkb9jFqcb0krN96s+tzG01ocC+gdLMeiXAuGpJnQ2fbXFGHriM3RU7g5W3DAZtIVSaprR0E2jFytRbxJZEXcF4Vat12IMGcz45xhQ3C9X7Pe7r+Gc7a1sV2pZG4E6Btkj8tjGdlGg4OESdVVPAr0IElggJ21+Isna9wJPKO34R6Gpm9SDXdMG6IqCcPZ7+KKQaF02xYc2U7vnB6olyjDqu0kSbQPtJ1Dzk8z7xbG2ArXlhSIV9YcEgRSthNONvs/R737PNJoT2Pg0c+p88BKKP7vt0FWMu+SrnFkfwo7mOKWwRNu7e8MSmGoRYGaZK1ix/wfKiXO0MvJumdETwg1RMajkQmX1OufHAlyo7ZPg8XoYqmFfnHyiUoUmKFPaEKoEXiyri8jMFKn1ug4zuLMpfrNRWdiW8RhXxa0sPojnNb/e2V9Lo3+2vbOrYlU2OWOIBxibZ2gh2ei+DtZz81XH21ddd2tdB30nFfnnCWwItfnPobyaSN/Mv3zYjLnUXU80fAkYFq4BB+KsJreKw4qUq66eIc7KbWknvKkTs5rR9nGt5Hy5lVvmogKBpKi8pzeVd7pYw55hF0BTk2mSBXvRBVu1VLmxTlfH5cgCIzskZVWAYdGJj8N0TXgvdx6Ic=
  - secure: qG49MRFtlG1rOttEddLrr5v54tomTd8v1ia32vMmmCIGA/jEH1a1yxMlu2d6YCvspUozarT0+gP9MYDeyKcuTeoCgjiPIRIuFO/7HkBflx3LeITyVAB/r2A1nXKt0kX4gkA7fxojw8/h8qg7oIognrSEMmnb1a61qtL4yLe4CLw+sTkV9fk5lCBTPuAgxGGLEb5d5e61keimLoxmcuXsCPhAzTvJYcJ3+xfhMSlWBkqjPyQbG4weXe+NsRSVL/n08INKA+h327MLv320QhZs2By9Q099Bb9ycUz0+77tNJhLPAGl69hLf3+z6Gc+9AIuq8CdEn8VkmPXNdmPbWFyGakPhfWpq38WJCuT490CFjSkM+d8lTjgIpjKYsIcvhljG0W8iUyTucdNR/lpgfP6RXnAW3u49jp5k6+PGYovnCDk7mMFSbNu1YpRHypnueI4ZswJWNi8zL4+UuMqk8BoBCSH17+bM1OIzOLboqIkXBnx7m33WSv+fbh/8lvk4YjAm2x/PvFq/kc9D6vgeTlnNFcAaiTQjHbaihgUP4lmjhknbHFORDmpURCj3RpRNewZX8EqpyC0ShWt7o+mrrfjHPoJKVrpKfP0EloeCWr643YTIhE8QqunXyD5yuxc1BKdiYrIF0c43qtSjDgf6cASCPgmhrXl+zGbebwYhcwGVUo=
  - secure: XMU2NPyattZDmShaRKDPwzoXsyBCKY0z37KvmhAL789vs59jNj7gwVaqQk2XLSntbi+xEB6mxV2gYkGWSLsLmiYgjt+nsmPa6qa50Lw6ic04iyeqhvoYh0Y9k5mdUdtPVSsMhGaOMEOfSrT15RNJ4jH8rlINfAViIuJ7MTgeP589mhd2JXXKadKEar5dacUpvfuNjSA1lYo38EdF+0XpLr/IuUNfkh0gVMphNSkCHIO8w/2WPgOStqiLzxDTfNVROIxYaVQhbk1HiqEXgnguG95JnXdl4YjMOEvaJTWBPNb+Lz2F0EY5v5dfuun1P8s8tP+NHwvyEDGdvcyJJMbW+ligemBVm8Y6Jf0sYp7/v/V2U1cjL2DiVCZp/2mzvNdqGVk12dBWLzQV5pBxPlGoSQGKdfUuecGMhDuEcwPn2axY5cF8JxGbaGikUBlJpnid5MP9VbfVuoZ/3YPxbEV1GLVjXKVKYrzXrx8wO2mdr5hMahsj217tDwa0C2fZWA+ywn6jibdX/5he1KyLQR46u7Kmbn/D5+wM97j3M2I9JX7EBfXtJFvRHLgklf9rYMFXibXToCsRj9xVis9fAOib6Rz4HVNLN+Y8ZMDc1rg3elT/n+FoEjELRdZdool1W9jO6wkjsyvz/jiHF82LyTgGVOVGlDBe6FJbaCaHsMbPAq4=
os: linux
cache:
  directories:
  - "$HOME/.npm"
before_install:
- cd server/
- npm i -g @nestjs/cli
install:
- npm install
jobs:
- include:
  - stage: test
    script: npm run test
  - script: npm run test:e2e
  - stage: deploy
    before_install:
    - pwd
    - pip install --user awscli
    - export PATH=$PATH:$HOME/.local/bin
    script:
    - eval $(aws ecr get-login --region --no-include-email us-east-2)
    - docker-compose build
    - docker tag strengdurance/server:latest 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:server-latest
    - docker tag strengdurance/frontend:latest 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:frontend-latest
    - docker push 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:server-latest
    - docker push 924554764504.dkr.ecr.us-east-2.amazonaws.com/strengdurance:frontend-latest
